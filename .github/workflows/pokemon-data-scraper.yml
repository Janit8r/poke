name: Pokemon Data Scraper

# è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      skip_images:
        description: 'è·³è¿‡å›¾ç‰‡ä¸‹è½½ (Skip image download)'
        required: false
        default: 'false'
        type: boolean
  # å®šæ—¶è§¦å‘ - æ¯å‘¨æ—¥UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * 0'

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.9'

jobs:
  scrape-pokemon-data:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # è®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # ç¼“å­˜Pythonä¾èµ–
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆChromeæµè§ˆå™¨å’ŒWebDriverï¼‰
    - name: Install Chrome and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg unzip
        # å®‰è£…Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        # å®‰è£…ChromeDriver
        CHROMEDRIVER_VERSION=$(curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE)
        wget -N http://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        # éªŒè¯å®‰è£…
        google-chrome --version
        chromedriver --version

    # å®‰è£…Pythonä¾èµ–
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    - name: Create directories
      run: |
        mkdir -p data/{pokemon,move,ability,images/{dream,official,home}}
        mkdir -p logs

    # è¿è¡Œæ•°æ®æŠ“å–è„šæœ¬
    - name: Run data scraping scripts
      run: |
        echo "å¼€å§‹æŠ“å–Pokemonæ•°æ®..."
        cd scripts
        
        # æŒ‰é¡ºåºæ‰§è¡Œè„šæœ¬
        echo "1. æŠ“å–å®å¯æ¢¦åŸºç¡€åˆ—è¡¨..."
        python pokemon_list.py
        
        echo "2. æŠ“å–ç‰¹æ€§åˆ—è¡¨..."
        python ability_list.py
        
        echo "3. æŠ“å–æ‹›å¼åˆ—è¡¨..."
        python move_list.py
        
        echo "4. æŠ“å–å®å¯æ¢¦è¯¦ç»†ä¿¡æ¯..."
        python pokemon.py
        
        echo "5. æŠ“å–ç‰¹æ€§è¯¦ç»†ä¿¡æ¯..."
        python ability.py
        
        echo "6. æŠ“å–æ‹›å¼è¯¦ç»†ä¿¡æ¯..."
        python move.py
        
        echo "7. ç”Ÿæˆå®Œæ•´å®å¯æ¢¦åˆ—è¡¨..."
        python pokemon_full_list.py
        
        # æ¡ä»¶æ€§æ‰§è¡Œå›¾ç‰‡ä¸‹è½½
        if [ "${{ github.event.inputs.skip_images }}" != "true" ]; then
          echo "8. ä¸‹è½½ç‰ˆæƒç»˜å›¾ç‰‡..."
          python download_dream_image.py
        else
          echo "8. è·³è¿‡å›¾ç‰‡ä¸‹è½½..."
        fi
        
        echo "æ•°æ®æŠ“å–å®Œæˆï¼"

    # ç”Ÿæˆæ•°æ®ç»Ÿè®¡æŠ¥å‘Š
    - name: Generate data statistics
      run: |
        cd data
        echo "# Pokemonæ•°æ®æŠ“å–æŠ¥å‘Š - $(date)" > ../scraping_report.md
        echo "" >> ../scraping_report.md
        
        # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
        echo "## æ•°æ®æ–‡ä»¶ç»Ÿè®¡" >> ../scraping_report.md
        echo "- å®å¯æ¢¦æ•°æ®: $(find pokemon -name "*.json" | wc -l) ä¸ªæ–‡ä»¶" >> ../scraping_report.md
        echo "- ç‰¹æ€§æ•°æ®: $(find ability -name "*.json" | wc -l) ä¸ªæ–‡ä»¶" >> ../scraping_report.md
        echo "- æ‹›å¼æ•°æ®: $(find move -name "*.json" | wc -l) ä¸ªæ–‡ä»¶" >> ../scraping_report.md
        echo "- ç‰ˆæƒç»˜å›¾ç‰‡: $(find images/dream -name "*.png" 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶" >> ../scraping_report.md
        echo "- å®˜æ–¹å›¾ç‰‡: $(find images/official -name "*.png" 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶" >> ../scraping_report.md
        echo "- Homeå›¾ç‰‡: $(find images/home -name "*.png" 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶" >> ../scraping_report.md
        echo "" >> ../scraping_report.md
        
        # ç»Ÿè®¡æ–‡ä»¶å¤§å°
        echo "## æ•°æ®å¤§å°ç»Ÿè®¡" >> ../scraping_report.md
        echo "- æ€»æ•°æ®å¤§å°: $(du -sh . | cut -f1)" >> ../scraping_report.md
        echo "- JSONæ•°æ®å¤§å°: $(du -sh pokemon move ability *.json 2>/dev/null | tail -1 | cut -f1 || echo '0')" >> ../scraping_report.md
        echo "- å›¾ç‰‡æ•°æ®å¤§å°: $(du -sh images 2>/dev/null | cut -f1 || echo '0')" >> ../scraping_report.md
        echo "" >> ../scraping_report.md
        
        # æ‰§è¡Œæ—¶é—´
        echo "## æ‰§è¡Œä¿¡æ¯" >> ../scraping_report.md
        echo "- æ‰§è¡Œæ—¶é—´: $(date)" >> ../scraping_report.md
        echo "- GitHub Actions Run ID: ${{ github.run_id }}" >> ../scraping_report.md
        echo "- æ˜¯å¦è·³è¿‡å›¾ç‰‡: ${{ github.event.inputs.skip_images }}" >> ../scraping_report.md
        
        # æ˜¾ç¤ºæŠ¥å‘Š
        cat ../scraping_report.md

    # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    - name: Verify critical files
      run: |
        echo "æ£€æŸ¥å…³é”®æ•°æ®æ–‡ä»¶..."
        files_to_check=(
          "data/pokemon_list.json"
          "data/pokemon_full_list.json"
          "data/ability_list.json"
          "data/move_list.json"
        )
        
        missing_files=0
        for file in "${files_to_check[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            missing_files=$((missing_files + 1))
          fi
        done
        
        if [ $missing_files -gt 0 ]; then
          echo "âš ï¸  æœ‰ $missing_files ä¸ªå…³é”®æ–‡ä»¶ç¼ºå¤±ï¼Œä½†ç»§ç»­å¤„ç†..."
        fi

    # å‹ç¼©æ•°æ®æ–‡ä»¶ï¼ˆä¸åŒ…å«å›¾ç‰‡ï¼Œå•ç‹¬å¤„ç†ï¼‰
    - name: Compress data files
      run: |
        echo "å‹ç¼©æ•°æ®æ–‡ä»¶..."
        # å‹ç¼©JSONæ•°æ®
        tar -czf pokemon-data-$(date +%Y%m%d).tar.gz \
          data/*.json \
          data/pokemon/ \
          data/ability/ \
          data/move/ \
          scraping_report.md \
          logs/ \
          --exclude="*.png" \
          --exclude="*.webp" \
          --exclude="*.jpg" \
          --exclude="*.jpeg"
        
        # å¦‚æœå›¾ç‰‡å­˜åœ¨ï¼Œå•ç‹¬å‹ç¼©å›¾ç‰‡æ–‡ä»¶
        if [ -d "data/images" ] && [ "$(find data/images -type f | wc -l)" -gt 0 ]; then
          echo "å‹ç¼©å›¾ç‰‡æ–‡ä»¶..."
          tar -czf pokemon-images-$(date +%Y%m%d).tar.gz data/images/
        fi
        
        # æ˜¾ç¤ºå‹ç¼©æ–‡ä»¶ä¿¡æ¯
        echo "å‹ç¼©æ–‡ä»¶ä¿¡æ¯:"
        ls -lh *.tar.gz

    # ä¸Šä¼ æ•°æ®æ–‡ä»¶ä½œä¸ºartifact
    - name: Upload data artifacts
      uses: actions/upload-artifact@v3
      with:
        name: pokemon-data-${{ github.run_number }}
        path: pokemon-data-*.tar.gz
        retention-days: 30

    # ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ä½œä¸ºartifactï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    - name: Upload image artifacts
      if: hashFiles('pokemon-images-*.tar.gz') != ''
      uses: actions/upload-artifact@v3
      with:
        name: pokemon-images-${{ github.run_number }}
        path: pokemon-images-*.tar.gz
        retention-days: 30

    # ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: scraping-logs-${{ github.run_number }}
        path: |
          logs/
          scraping_report.md
        retention-days: 7

    # å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½®secretsï¼‰
    - name: Notify completion
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Pokemonæ•°æ®æŠ“å–æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“Š æ•°æ®æ–‡ä»¶å·²æ‰“åŒ…ä¸º: pokemon-data-$(date +%Y%m%d).tar.gz"
          if [ -f "pokemon-images-$(date +%Y%m%d).tar.gz" ]; then
            echo "ğŸ–¼ï¸  å›¾ç‰‡æ–‡ä»¶å·²æ‰“åŒ…ä¸º: pokemon-images-$(date +%Y%m%d).tar.gz"
          fi
          echo "ğŸ“ å¯ä»GitHub Actionsé¡µé¢çš„Artifactsä¸­ä¸‹è½½"
        else
          echo "âŒ Pokemonæ•°æ®æŠ“å–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
        fi

# è®¾ç½®ä½œä¸šè¶…æ—¶ï¼ˆ4å°æ—¶ï¼‰
  timeout-minutes: 240
